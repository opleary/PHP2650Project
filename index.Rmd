---
output: md_document
author: "Nancy Liu & Breanna Richards"
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
library(tidyverse)
library(lubridate)
library(ical)
library(kableExtra)
library(janitor)
library(reshape2)
library(data.table)
library(ggplot2)
library(ggthemes)
library(gganimate)
library(gifski)
library(survival)
library(randomForestSRC)
library(readr)
library(tidyverse)
library(tidyr)
```

# Predicting Survival and Controlling for Biased with Random Survival Forests and Condtional Inference Forests Using Right-Censored Data

## What is Survival Analysis?

Survival

## Review of Random Forests

## Random Survival Forests

## Conditional Inference Forests

## Methods

## Results

### PBC Data

Primary sclerosing cholangitis is an autoimmune disease leading to destruction of the small bile ducts in the liver. Progression is slow but inexorable, eventually leading to cirrhosis and liver decompensation.

This data is from the Mayo Clinic trial in PBC conducted between 1974 and 1984. A total of 424 PBC patients met eligibility criteria for the randomized placebo controlled trial of the drug D-penicillamine. This dataset tracks survival status until end up follow up period as well as contains many covariates collected during the clinical trial.

```{r}
pbc_vars <- data.frame(
  Variable = c("id", "time", "status", "trt", "age",
                "sex", "ascites", "hepato", "spiders",
                "edema", "bili", "chol", "albumin",
                "copper", "alk.phos", "ast", "trig",
                "platelet", "protime", "stage"),
  Description = c("case number", "number of days between registration and the earlier of death",
                  "status at endpoint, 0/1/2 for censored, transplant, dead", "1/2/NA for D-penicillmain, placebo, not randomised", "in years", "m/f",
                  "presence of ascites", "presence of hepatomegaly or enlarged liver", "blood vessel malformations in the skin", "0 no edema, 0.5 untreated or successfully treated 1 edema despite diuretic therapy",
                  "serum bilirunbin (mg/dl)",
                  "serum cholesterol (mg/dl)", "serum albumin (g/dl)",
                  "urine copper (ug/day)", "alkaline phosphotase (U/liter)",
                  "aspartate aminotransferase, once called SGOT (U/ml)",
                  "triglycerides (mg/dl)",
                  "platelet count", "standardised blood clotting time",
                  "histologic stage of disease (needs biopsy)")
)
# example
```

```{r}

#kable(pbc_vars)
```

| Variable | Description                                                                        |
|-----------------------|-------------------------------------------------|
| id       | case number                                                                        |
| time     | number of days between registration and the earlier of death                       |
| status   | status at endpoint, 0/1/2 for censored, transplant, dead                           |
| trt      | 1/2/NA for D-penicillmain, placebo, not randomised                                 |
| age      | in years                                                                           |
| sex      | m/f                                                                                |
| ascites  | presence of ascites                                                                |
| hepato   | presence of hepatomegaly or enlarged liver                                         |
| spiders  | blood vessel malformations in the skin                                             |
| edema    | 0 no edema, 0.5 untreated or successfully treated 1 edema despite diuretic therapy |
| bili     | serum bilirunbin (mg/dl)                                                           |
| chol     | serum cholesterol (mg/dl)                                                          |
| albumin  | serum albumin (g/dl)                                                               |
| copper   | urine copper (ug/day)                                                              |
| alk.phos | alkaline phosphotase (U/liter)                                                     |
| ast      | aspartate aminotransferase, once called SGOT (U/ml)                                |
| trig     | triglycerides (mg/dl)                                                              |
| platelet | platelet count                                                                     |
| protime  | standardised blood clotting time                                                   |
| stage    | histologic stage of disease (needs biopsy)                                         |

```{r}
#pbc_rf <- rfsrc(Surv(years, status) ~ ., data = pbc,
 #nsplit = 10,
 #na.action = "na.impute")

```

\textbf{Hepatitis Data}

```{r}
hepatitis <- read_csv("GitHub/PHP2650Project/data/hepatitis.csv")[, 1:3]

hepatitis[hepatitis$censor == "loss to follow-up",]$censor <- "censored"

hepatitis <- hepatitis %>%
mutate(censor = ifelse(censor == "censored", 0, 1),
group = as.factor(ifelse(group == "prednisolone", 1, 2)))

#hepatitis$T <- Surv(time = hepatitis$time, event = hepatitis$censor)

#km <- survfit(T ~ group, data = hepatitis)
```

```{r}
#hep_rf <- rfsrc(Surv(time, censor) ~ ., data = hepatitis,
 #na.action = "na.impute")

#get.cindex(time = hepatitis$time, censoring = hepatitis$censor, predicted = hep_rf$predicted.oob)

# yhat <- get.mv.predicted(hep_rf, oob = TRUE)

```

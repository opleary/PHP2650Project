---
output: md_document
author: "Nancy Liu & Breanna Richards"
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = FALSE)
library(tidyverse)
library(lubridate)
library(ical)
library(kableExtra)
library(janitor)
library(reshape2)
library(data.table)
library(ggplot2)
library(ggthemes)
library(gganimate)
library(gifski)
library(survival)
library(randomForestSRC)
library(readr)
library(tidyverse)
library(tidyr)
```

# Predicting Survival and Controlling for Bias with Random Survival Forests and Conditional Inference Forests

## What is Survival Analysis?

The main goal of survival analysis is to analyze and estimate the expected amount of time until an event of interest occurs for a subject or groups of subjects. Originally, survival analysis was developed for the primary use of measuring the lifespans of certain populations. However, over time its utilities have extended to a wide array of applications even outside of the domain of healthcare. Thus, while biological death continues to be the main outcome under the scrutiny of survival analysis, other outcomes of interest may include time to mechanical failure, time to repeat offense of a released inmate, time to the split of a financial stock and more! Time in survival analysis is relative and all subjects of interest are likened to a common starting point at baseline (t = 0) with a 100% probability of not experiencing the event of interest.

Subjects are observed from baseline to some often pre-specified time at the end of study. Thus, not every subject will experience the event of interest within the observational period's time frame. In this case, we don't know if or when these subjects will experience the event, we just know that they have not experienced it during the study period. This is called **censoring**, more specifically, right-censoring. Right censoring is just one of multiple forms of censoring that survival data strives to adjust for and the form that we will focus on in this comprehensive review. Dropout is also a form of right censoring. The event of interest can happen during the specified time frame, outside of the time frame, or not at all but we don't know which scenario applies to the individuals that leave the study early.

![](img/right_cens_img.png){width="551"}

It's imperative that we still consider these censored observations in our study instead of removing them so that we don't bias our results towards only those individuals that experienced the event of interest within the observational time frame. Thus, in survival analysis, not only do we include time from baseline at event of interest, but we also include a binary variable indicating whether an individual experienced the event or was censored instead.

In standard survival analysis, the **survival function**, S(t) is what defines the probability that the event of interest has **not** yet happened at time = t.

```{r}

# <div align="center"><img src="https://render.githubusercontent.com/render/math?math=\Large S(t) = P(T > t)"></div>

```

S(t) is non-increasing and ranges between 0 and 1. The hazard function on the other hand is defined as the instantaneous risk of an individual experiencing the event of interest within a small time frame.

```{r}

## <div align="center"><img src="https://render.githubusercontent.com/render/math?math=\Large h(t) = lim_{\delta t \rightarrow 0} \frac{Pr(t \le T \le t + \delta t | T> t)}{\delta t}"></div>

```

Both survival functions and hazard functions are alternatives to probability density functions and are better suited for survival data.

Survival regression involves not only information about censorship and time to event, but also additional predictor variables of interest like the sex, age, race, etc. of an individual. Cox proportional hazards models is a popular and widely utilized modeling technique for survival data because it considers the effects of covariates on the outcome of interest as well as examines the relationships between these variables and the survival distribution. While this model is praised for its flexibility and simplicity, it is also often criticized for its restrictive proportional hazards assumption.

The proportional hazards assumption states that the relative hazard remains constant over time across the different strata/covariate levels in the data. For example...

![](img/PH_assumption_good_check.png)

## Review of Random Forests

## Random Survival Forests

## Conditional Inference Forests

## Applications

### PBC Data

Primary sclerosing cholangitis is an autoimmune disease leading to destruction of the small bile ducts in the liver. Progression is slow but inexorable, eventually leading to cirrhosis and liver decompensation.

This data is from the Mayo Clinic trial in PBC conducted between 1974 and 1984. A total of 424 PBC patients met eligibility criteria for the randomized placebo controlled trial of the drug D-penicillamine. This dataset tracks survival status until end up follow up period as well as contains many covariates collected during the clinical trial.

| Variable | Description                                                                        |
|----------|------------------------------------------------------------------------------------|
| id       | case number                                                                        |
| time     | number of days between registration and the earlier of death                       |
| status   | status at endpoint, 0/1/2 for censored, transplant, dead                           |
| trt      | 1/2/NA for D-penicillmain, placebo, not randomised                                 |
| age      | in years                                                                           |
| sex      | m/f                                                                                |
| ascites  | presence of ascites                                                                |
| hepato   | presence of hepatomegaly or enlarged liver                                         |
| spiders  | blood vessel malformations in the skin                                             |
| edema    | 0 no edema, 0.5 untreated or successfully treated 1 edema despite diuretic therapy |
| bili     | serum bilirunbin (mg/dl)                                                           |
| chol     | serum cholesterol (mg/dl)                                                          |
| albumin  | serum albumin (g/dl)                                                               |
| copper   | urine copper (ug/day)                                                              |
| alk.phos | alkaline phosphotase (U/liter)                                                     |
| ast      | aspartate aminotransferase, once called SGOT (U/ml)                                |
| trig     | triglycerides (mg/dl)                                                              |
| platelet | platelet count                                                                     |
| protime  | standardised blood clotting time                                                   |
| stage    | histologic stage of disease (needs biopsy)                                         |

```{r}
#pbc_rf <- rfsrc(Surv(years, status) ~ ., data = pbc,
 #nsplit = 10,
 #na.action = "na.impute")

```

### Employee Turnover Data

A dataset found on Kaggle containing the employee attrition information of 1,129 employees and information about time to turnover, their gender, age, industry, profession, employee pipeline information, the presence of a coach on probation, the gender of their supervisor, and wage information.

```{r}
turnover <- read_csv("data/turnover.csv")
#ncol(turnover)
#head(turnover)
#table(turnover$way)
#colnames(turnover)

```

| Variable     | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| stag         | Experience (time)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| event        | Employee turnover                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| gender       | Employee's gender, female (f), or male (m)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| age          | Employee's age (year)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| industry     | Employee's Industry                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| profession   | Employee's profession                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| traffic      | From what pipeline employee came to the company. 1. contacted the company directly (advert). 2. contacted the company directly on the recommendation of a friend that's not an employee of the company (recNErab). 3. contacted the company directly on the recommendation of a friend that IS an employee of the company (referal). 4. applied for a vacany on the job site (youjs) 5. recruiting agency brought you to the employer (KA) 6. invited by an employer known before employment (friends). 7. employer contacted on the recommendation of a person who knows the employee (rabrecNErab). 8. employer reached you through your resume on the job site (empjs). |
| coach        | presence of a coach (training) on probation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| head_gender  | head (supervisor) gender (m/f)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| greywage     | The salary does not seem to the tax authorities. Greywage in Russia or Ukraine means that the employer (company) pay just a tiny bit amount of salary above the white-wage (white-wage means minimum wage) (white/gray)                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| way          | Employee's way of transportation (bus/car/foot)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| extraversion | Extraversion score                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| independ     | Independend score                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| selfcontrol  | Self-control score                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| anxiety      | Anxiety Score                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| novator      | Novator Score                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |

```{r}
hepatitis <- read_csv("data/hepatitis.csv")[, 1:3]

hepatitis[hepatitis$censor == "loss to follow-up",]$censor <- "censored"

hepatitis <- hepatitis %>%
mutate(censor = ifelse(censor == "censored", 0, 1),
group = as.factor(ifelse(group == "prednisolone", 1, 2)))

#hepatitis$T <- Surv(time = hepatitis$time, event = hepatitis$censor)

#km <- survfit(T ~ group, data = hepatitis)
```

```{r}
#hep_rf <- rfsrc(Surv(time, censor) ~ ., data = hepatitis,
 #na.action = "na.impute")

#get.cindex(time = hepatitis$time, censoring = hepatitis$censor, predicted = hep_rf$predicted.oob)

# yhat <- get.mv.predicted(hep_rf, oob = TRUE)

```

{% include lib/mathjax.html %}
